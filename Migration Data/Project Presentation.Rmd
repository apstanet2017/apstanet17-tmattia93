---
title: "Project Presenatation"
author: "Taylor Mattia"
date: "December 6, 2017"
output: html_document
---
##Project Goals:

* Construct county-to-county migration data sets from preexisting census data and county covariate information
* Create spatial visualizations of this migration 
* Estimate summary statistics for the network including centrality measures (to see if some counties are more important than others), in-and-out degrees for specific counties, and the degree distribution of the entire network
* Determine whether particular county-covariates, including median income, unemployment, educational attainment, poverty rates, and racial demographic information, can accurately predict the formation of county-to-county migratory networks


```{r setup, include=FALSE}
#Clear Memory
rm(list = ls())
```

```{r, include=FALSE}
library(sna)
library(visNetwork)
library(threejs)
library(networkD3)
library(ggplot2)
library(ggstance)
library(ggmcmc)
library(coda)
library(gdata)
library(readxl)
library(dplyr)
library(foreign)
library(haven)
library(plyr)
library(statnet)
library(igraph)
library(network)
library(sand)
library(intergraph)
library(ergm)
library(maps)
library(geosphere)
library(ergm.count)
library(ergm.rank)
library(GERGM)
library(bootnet)
library(glasso)
library(qgraph)
```

```{r include=FALSE}
#Set working directory
setwd('~/Dropbox/github/Migration Data')
```

## Example: County-to-County Migration between 2011 and 2015
```{r, echo=FALSE, include=F}
#Loading the data 
#Migration Data
migration_1115 <-get(load('states1115.Rdata'))

#Covariate Data
county_covariate <-get(load('county_covariate.Rdata'))
```

```{r, echo=FALSE, results="hide"}
#Cleaning data to exclude Alaska and Hawaii
#Merge covariate information with migration data 
#Changing column name for merge
colnames(county_covariate)[1] <- "sendfips"

#Exclusing Alaska and Hawaii (sending and receiving)
#Identifying counties in Alaska
subset(county_covariate$sendfips, county_covariate$state==2)

#Removing them from data frame

alaska <- list("2013", "2016", "2020", "2050", "2060", "2068", "2070", "2090", "2100",
               "2105", "2110", "2122", "2130", "2150", "2158", "2164", "2170", "2180", "2185",
               "2188", "2195", "2198", "2220", "2230", "2240", "2261", "2270", "2275",
               "2282", "2290")

migration_1115 <- migration_1115[!(migration_1115$sendfips %in% alaska), ]
migration_1115 <- migration_1115[!(migration_1115$recfips %in% alaska), ]

#Identifying counties in Hawaii
subset(county_covariate$sendfips,county_covariate$state==15)

#Removing them from data frame
hawaii <-list("15001", "15003", "15005", "15007", "15009", "46102")

migration_1115 <- migration_1115[!(migration_1115$sendfips %in% hawaii), ]
migration_1115 <- migration_1115[!(migration_1115$recfips %in% hawaii), ]

#Subsetting covariate information to exclude Alaska and Hawaii 
migration_1115 <- subset(migration_1115, migration_1115$sendfips!="NA")
county_covariate <- subset(county_covariate, county_covariate$state!=2)
county_covariate <- subset(county_covariate, county_covariate$state!=15)

#Merging migration information with covariate data
states1115_migration_covariate <- merge(migration_1115, county_covariate, by="sendfips", all.x=T)
```

The structure of the data is as follows:
```{r, echo=FALSE}
head(migration_1115)
```

First, I created a network from the edgelist where each edge is weighted by the number of people who moved from County A (sending county) to County B (receiving county) between 2011 and 2015:

```{r}
edgelist_states1115 <- as.matrix(migration_1115)
graph_states1115 = graph.edgelist(edgelist_states1115[,1:2], directed=T)
E(graph_states1115)$weight = as.numeric(edgelist_states1115[,3])
```

I also added the following covariate information as vertex attributes from the U.S. Census, measured at the county level:

* Location descriptors (county and state name, latitude, and longitude)
* Household income (2009 - 2015)
* High school graduation rates (2009-2015)
* Household poverty rates (2009-2015)
* Unemployment rate (2009 - 2015)
* Total population (2010 - 2015)
* County-level populations by race (2010 - 2015)

```{r, echo=F, include=F}
#Setting vertex attributes (nodal covariates)
#1) Need to remove spaces from name string
V(graph_states1115)$name <- gsub(" ", "", V(graph_states1115)$name, fixed = TRUE)

#2) Setting vertex attributes
#Location Descriptors
V(graph_states1115)$state_name = as.character(county_covariate$statename[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$state_number = as.character(county_covariate$state[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$county_name = as.character(county_covariate$countyname[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$county_string = as.character(county_covariate$countystring[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$latitude = as.character(county_covariate$Latitude[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$longitude = as.character(county_covariate$Longitude[match(V(graph_states1115)$name, county_covariate$sendfips)])

#Household income (2009 - 2015)
V(graph_states1115)$hhincome_2009 = as.character(county_covariate$hhincome_2009[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$hhincome_2010 = as.character(county_covariate$hhincome_2010[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$hhincome_2011 = as.character(county_covariate$hhincome_2011[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$hhincome_2012 = as.character(county_covariate$hhincome_2012[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$hhincome_2013 = as.character(county_covariate$hhincome_2013[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$hhincome_2014 = as.character(county_covariate$hhincome_2013[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$hhincome_2015 = as.character(county_covariate$hhincome_2013[match(V(graph_states1115)$name, county_covariate$sendfips)])

#Unemployment rate (2009 - 2015)
V(graph_states1115)$unemployment_rate_2009 = as.character(county_covariate$unemploymentrate_2009[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$unemployment_rate_2010 = as.character(county_covariate$unemploymentrate_2010[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$unemployment_rate_2011 = as.character(county_covariate$unemploymentrate_2011[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$unemployment_rate_2012 = as.character(county_covariate$unemploymentrate_2012[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$unemployment_rate_2013 = as.character(county_covariate$unemploymentrate_2013[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$unemployment_rate_2014 = as.character(county_covariate$unemploymentrate_2014[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$unemployment_rate_2015 = as.character(county_covariate$unemploymentrate_2015[match(V(graph_states1115)$name, county_covariate$sendfips)])

#High School Graduation Rate (2009 - 2015)
V(graph_states1115)$hs_gradrate_2009 = as.character(county_covariate$hs_gradrate_2009[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$hs_gradrate_2010 = as.character(county_covariate$hs_gradrate_2010[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$hs_gradrate_2011 = as.character(county_covariate$hs_gradrate_2011[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$hs_gradrate_2012 = as.character(county_covariate$hs_gradrate_2012[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$hs_gradrate_2013 = as.character(county_covariate$hs_gradrate_2013[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$hs_gradrate_2014 = as.character(county_covariate$hs_gradrate_2014[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$hs_gradrate_2015 = as.character(county_covariate$hs_gradrate_2015[match(V(graph_states1115)$name, county_covariate$sendfips)])

#Household Poverty Rate (2009 - 2015)
V(graph_states1115)$hh_poverty_rate_2009 = as.character(county_covariate$hh_poverty_rate_2009[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$hh_poverty_rate_2010 = as.character(county_covariate$hh_poverty_rate_2010[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$hh_poverty_rate_2011 = as.character(county_covariate$hh_poverty_rate_2011[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$hh_poverty_rate_2012 = as.character(county_covariate$hh_poverty_rate_2012[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$hh_poverty_rate_2013 = as.character(county_covariate$hh_poverty_rate_2013[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$hh_poverty_rate_2014 = as.character(county_covariate$hh_poverty_rate_2014[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$hh_poverty_rate_2015 = as.character(county_covariate$hh_poverty_rate_2014[match(V(graph_states1115)$name, county_covariate$sendfips)])

#Total population (2010 - 2015)
V(graph_states1115)$total_pop_2010 = as.character(county_covariate$total_pop_2010[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$total_pop_2011 = as.character(county_covariate$total_pop_2011[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$total_pop_2012 = as.character(county_covariate$total_pop_2012[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$total_pop_2013 = as.character(county_covariate$total_pop_2013[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$total_pop_2014 = as.character(county_covariate$total_pop_2014[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$total_pop_2015 = as.character(county_covariate$total_pop_2015[match(V(graph_states1115)$name, county_covariate$sendfips)])

# Racial information 
V(graph_states1115)$perc_white_2010 = as.character(county_covariate$perc_white_2010[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$perc_white_2011 = as.character(county_covariate$perc_white_2011[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$perc_white_2012 = as.character(county_covariate$perc_white_2012[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$perc_white_2013 = as.character(county_covariate$perc_white_2013[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$perc_white_2014 = as.character(county_covariate$perc_white_2014[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$perc_white_2015 = as.character(county_covariate$perc_white_2015[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$perc_black_2010 = as.character(county_covariate$perc_black_2010[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$perc_black_2011 = as.character(county_covariate$perc_black_2011[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$perc_black_2012 = as.character(county_covariate$perc_black_2012[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$perc_black_2013 = as.character(county_covariate$perc_black_2013[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$perc_black_2014 = as.character(county_covariate$perc_black_2014[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$perc_black_2015 = as.character(county_covariate$perc_black_2015[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$perc_latino_2010 = as.character(county_covariate$perc_latino_2010[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$perc_latino_2011 = as.character(county_covariate$perc_latino_2011[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$perc_latino_2012 = as.character(county_covariate$perc_latino_2012[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$perc_latino_2013 = as.character(county_covariate$perc_latino_2013[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$perc_latino_2014 = as.character(county_covariate$perc_latino_2014[match(V(graph_states1115)$name, county_covariate$sendfips)])
V(graph_states1115)$perc_latino_2015 = as.character(county_covariate$perc_latino_2015[match(V(graph_states1115)$name, county_covariate$sendfips)])


```
After I construct the data in this manner, I can visualize the data in a number of ways: 

1. Within state migration (e.g. Texas)
```{r, results="hide"}
#Subset all migration to and from Texas Counties 
states1115_texas_complete <-subset(states1115_migration_covariate, states1115_migration_covariate$state==48)

#Intra-texas migration
states1115_texas_complete <- states1115_texas_complete[grepl("^48[0-9]", states1115_texas_complete$sendfips), ]
states1115_texas_complete <- states1115_texas_complete[grepl("^48[0-9]", states1115_texas_complete$recfips), ]

#Making weighted edge numeric for the purposes of plotting
states1115_texas_complete$movers <- as.numeric(as.factor(states1115_texas_complete$movers))
```

```{r, eval=FALSE, echo=T}
# Plot a map of the united states:
map("state", region="texas", col="grey20", fill=TRUE, bg="black", lwd=0.1)

#Generating color gradient for edges in the network 
col.1 <- adjustcolor("orange red", alpha=0.4)
col.2 <- adjustcolor("orange", alpha=0.4)
edge.pal <- colorRampPalette(c(col.1, col.2), alpha = TRUE)
edge.col <- edge.pal(100)

#Generating "arcs" between each pair of coordinates
for(i in 1:nrow(states1115_texas_complete))  {
  node1 <- county_covariate[county_covariate$sendfips == states1115_texas_complete[i,]$sendfips,]
  node2 <- county_covariate[county_covariate$sendfips == states1115_texas_complete[i,]$recfips,]
  
  arc <- gcIntermediate( c(node1[1,]$Longitude, node1[1,]$Latitude), 
                         c(node2[1,]$Longitude, node2[1,]$Latitude), 
                         n=100, addStartEnd=TRUE )
  edge.ind <- round(25*states1115_texas_complete[i,]$movers / max(states1115_texas_complete$movers))
  
  lines(arc, col=edge.col[edge.ind], lwd=edge.ind/30)
}
```

![](/Users/taylormattia/Dropbox/github/Migration Data/texas.png)

2. Migration to a particular location (i.e. Colorado)
```{r, eval=FALSE, echo = F}
#Migration to Colorado
states1115_migration_to_colorado <- states1115_migration_covariate[grepl("^8[0-9]", states1115_migration_covariate$recfips), ] 
states1115_migration_to_colorado$movers <- as.numeric(as.factor(states1115_migration_to_colorado$movers ))
  
#Plot map of the United States
map("state", col="grey20", fill=TRUE, bg="black", lwd=0.1)

#Show migration to Colorado from all other counties in the U.S. 
for(i in 1:nrow(states1115_migration_to_colorado))  {
  node1 <- county_covariate[county_covariate$sendfips == states1115_migration_to_colorado[i,]$sendfips,]
  node2 <- county_covariate[county_covariate$sendfips == states1115_migration_to_colorado[i,]$recfips,]
  
  arc <- gcIntermediate( c(node1[1,]$Longitude, node1[1,]$Latitude), 
                         c(node2[1,]$Longitude, node2[1,]$Latitude), 
                         n=100, addStartEnd=TRUE )
  edge.ind <- round(10*states1115_migration_to_colorado[i,]$movers / max(states1115_migration_to_colorado$movers))
  
  lines(arc, col=edge.col[edge.ind], lwd=edge.ind/30)
}
```

![](/Users/taylormattia/Dropbox/github/Migration Data/colorado.png)


3. Migration from a particular location (i.e. New York City)
```{r, eval=FALSE, echo = F}
#Migration from counties in NYC (all five boroughs) to other parts of the country
states1115_migration_from_ny <- states1115_migration_covariate[states1115_migration_covariate$sendfips %in% c("36005", "36047", "36061", "36081", "36085"), ] 

states1115_migration_from_ny$movers <- as.numeric(as.factor(states1115_migration_from_ny$movers))

#Show migration from NYC to all other counties in the U.S.
map("state", col="grey20", fill=TRUE, bg="black", lwd=0.1)

#Show migration from NYC to all other counties in the U.S. 
for(i in 1:nrow(states1115_migration_from_ny))  {
  node1 <- states1115_migration_covariate[states1115_migration_covariate$sendfips == states1115_migration_from_ny[i,]$sendfips,]
  node2 <- states1115_migration_covariate[states1115_migration_covariate$sendfips == states1115_migration_from_ny[i,]$recfips,]
  
  arc <- gcIntermediate( c(node1[1,]$Longitude, node1[1,]$Latitude), 
                         c(node2[1,]$Longitude, node2[1,]$Latitude), 
                         n=1000, addStartEnd=TRUE )
  edge.ind <- round(25*states1115_migration_from_ny[i,]$movers / max(states1115_migration_from_ny$movers))
  
  lines(arc, col=edge.col[edge.ind], lwd=edge.ind/30)
}
```

![](/Users/taylormattia/Dropbox/github/Migration Data/nyc.png)

## Summary Statistics
1) Number of Degrees (number of people who moved in and out of a country):
```{r}
degree_weighted <- strength(graph_states1115)
head(sort(degree_weighted, decreasing=T), n = 10)
```


2) Number of In Degrees (number of people who moved into a county):
```{r}
in_degree_weighted <-strength(graph_states1115, mode=c("in"))
head(sort(in_degree_weighted, decreasing=T), n=10)
```

3) Number of Out Degrees (number of people who moved out of a county):
```{r}
out_degree_weighted <-strength(graph_states1115, mode=c("out"))
head(sort(out_degree_weighted, decreasing=T), n=10)
```
4) Eigenvector Centrality 
```{r, message=F, warning=F}
eigen_centrality <- eigen_centrality(graph_states1115, directed=T, weights=E(graph_states1115)$weight)$vector
```

```{r, echo=F, include=F}
node_county_names <- V(graph_states1115)$county_name 
node_state_names <- V(graph_states1115)$state_name

eigen_centrality_display <- rbind(eigen_centrality, node_county_names, node_state_names)
eigen_centrality_display_transpose <- t(eigen_centrality_display)
eigen_centrality_data <- as.data.frame(eigen_centrality_display_transpose, stringsAsFactors=F)
eigen_centrality_data$eigen_centrality <- as.numeric(as.character(eigen_centrality_data$eigen_centrality))
```

```{r, echo=F}
head(dplyr::arrange(eigen_centrality_data, desc(eigen_centrality)), n = 10)
```

5) Degree Prestige (receiving many ties from other counties)

```{r}
net_migration_states1115 <-intergraph::asNetwork(graph_states1115, ignore.eval=FALSE,
                                                 names.eval='weight')

degree_prestige <- sna::prestige(net_migration_states1115, cmode="indegree")
```

```{r, echo=F, include=F}
degree_prestige_display <- rbind(degree_prestige, node_county_names, node_state_names)
degree_prestige_display_transpose <- t(degree_prestige_display)
degree_prestige_data <- as.data.frame(degree_prestige_display_transpose, stringsAsFactors = F)
degree_prestige_data$degree_prestige <- as.numeric(as.character(degree_prestige_data$degree_prestige))
```

```{r, echo=F}
head(dplyr::arrange(degree_prestige_data, desc(degree_prestige)), n = 10)
```

6) Rank prestige (sum of prestige of neighbors)
```{r}
rank_presitge <- sna::prestige(net_migration_states1115, cmode="eigenvector")
```

```{r, echo=F, include=F}
rank_prestige_display <- rbind(rank_presitge, node_county_names, node_state_names)
rank_prestige_display_transpose <- t(rank_prestige_display)
rank_prestige_data <- as.data.frame(rank_prestige_display_transpose, stringsAsFactors=F)
rank_prestige_data$rank_presitge <- as.numeric(as.character(rank_prestige_data$rank_presitge))
```

```{r, echo=F}
head(dplyr::arrange(rank_prestige_data, desc(rank_presitge)), n = 10)
```

## ERGM Models
I am interested to see if the observed network can be predicted based on observable covariates. In particular, I am intersted to see whether:

* County covariates themselves can predict where people move to and from (i.e. people move out of county A  because the high school graduation rate is low) or
* Differences between counties matter (i.e. people move from county A to county B because county B has a lower unemployment rate compared to county B)

These ERGM models are computationally intensive (and take quite a long time to run), so I will present the code I plan to use to test which model best fits the observed data:

1. Define the function
+ Nodal Covariates ("Sender" and "Receiver")
```{r, eval=F, results="hide"}
model_sender_and_receiver <- net_migration_states1115 ~ edges + mutual  
                                        + nodeicov("unemployment_rate_2010") + nodeocov("unemployment_rate_2010")
                                        + nodeicov("hhincome_2010") + nodeocov("hhincome_2010")
                                        + nodeicov("hs_gradrate_2010") + nodeocov("hs_gradrate_2010")
                                        + nodeicov("hh_poverty_rate_2010") + nodeocov("hh_poverty_rate_2010")
                                        + nodeicov("perc_white_2010") + nodeocov("perc_white_2010")
                                        + nodeicov("total_pop_2010") + nodeocov("total_pop_2010") + 
                                        nodematch("state_name", diff=T) 

```

+ Difference in Nodal Covariates 
```{r, eval=F, results="hide"}
model_absolute_difference <- net_migration_states1115 ~ edges + mutual + nodematch("state_name", diff=T) +
                            + absdiff("unemployment_rate_2010") + absdifference("hhincome_2010") 
                            + absdiff("hs_gradrate_2010") + absdifference("hh_poverty_rate_2010")
                            + absdiff("perc_white_2010") + absdifference("total_pop_2010")
```

2. Apply ERGM function to fit each model separately
```{r, eval=F, results="hide"}
model_sender_and_receiver_fit <- ergm(model_sender_and_receiver,
                        control=control.ergm(seed=1),
                        response="weight",
                        reference=~Poisson,
                        verbose=T,
                        eval.loglik=TRUE)

model_absolute_difference_fit <- ergm(model_absolute_difference, 
                                      control=control.ergm(seed=1),
                                      response="weight",
                                      reference=~Poisson,
                                      verbose=T,
                                      eval.loglik=TRUE)
```

3. Simulate from each model fit
```{r, eval=F, results="hide"}
sender_and_receiver_sim <- simulate(model_sender_and_receiver_fit, nsims=100)

absolute_difference_sim <- simulate(model_absolute_difference_fit, nsims=100)

```
4. Goodness of fit and MCMC Diagnostics 
```{r, eval=F, results="hide"}
model_sender_and_receiver_gof <- gof(model_sender_and_receiver_fit ~ model)
model_absolute_difference_gof <- gof(model_absolute_difference_fit ~ model)

mcmc.diagnostics(model_sender_and_receiver_fit)
mcmc.diagnostics(model_absolute_difference_fit)
```