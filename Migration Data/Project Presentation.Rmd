---
title: "Project Presenatation"
author: "Taylor Mattia"
date: "December 6, 2017"
output: html_document
---
##Project Goals:

* Construct county-to-county migration data sets from preexisting census data and county covariate information
* Create spatial visualizations of this migration 
* Estimate summary statistics for the network including centrality measures (to see if some counties are more important than others), in-and-out degrees for specific counties, and the degree distribution of the entire network
* Determine whether particular county-covariates, including median income, unemployment, educational attainment, poverty rates, and racial demographic information, can accurately predict the formation of county-to-county migratory networks


```{r setup, include=FALSE}
#Clear Memory
rm(list = ls())
```

```{r, include=FALSE}
#Load Libraries
library(sna)
library(visNetwork)
library(threejs)
library(networkD3)
library(ggplot2)
library(ggstance)
library(ggmcmc)
library(coda)
library(gdata)
library(readxl)
library(dplyr)
library(foreign)
library(haven)
library(plyr)
library(statnet)
library(igraph)
library(network)
library(maps)
library(geosphere)
```

```{r include=FALSE}
#Set working directory
setwd('~/Dropbox/github/Migration Data')
```

## Example: County-to-County Migration between 2011 and 2015
```{r include=FALSE}
#Loading the data 
#Migration Data
migration_1115 <-get(load('states1115.Rdata'))

#Covariate Data
county_covariate <-get(load('county_covariate.Rdata'))
```

```{r include=FALSE}
#Cleaning data to exclude Alaska and Hawaii
#Merge covariate information with migration data 
#Changing column name for merge
colnames(county_covariate)[1] <- "sendfips"

#Exclusing Alaska and Hawaii (sending and receiving)
#Identifying counties in Alaska
subset(county_covariate$sendfips, county_covariate$state==2)

#Removing them from data frame

alaska <- list("2013", "2016", "2020", "2050", "2060", "2068", "2070", "2090", "2100",
               "2105", "2110", "2122", "2130", "2150", "2158", "2164", "2170", "2180", "2185",
               "2188", "2195", "2198", "2220", "2230", "2240", "2261", "2270", "2275",
               "2282", "2290")

migration_1115 <- migration_1115[!(migration_1115$sendfips %in% alaska), ]
migration_1115 <- migration_1115[!(migration_1115$recfips %in% alaska), ]

#Identifying counties in Hawaii
subset(county_covariate$sendfips,county_covariate$state==15)

#Removing them from data frame
hawaii <-list("15001", "15003", "15005", "15007", "15009", "46102")

migration_1115 <- migration_1115[!(migration_1115$sendfips %in% hawaii), ]
migration_1115 <- migration_1115[!(migration_1115$recfips %in% hawaii), ]

#Subsetting covariate information to exclude Alaska and Hawaii 
migration_1115 <- subset(migration_1115, migration_1115$sendfips!="NA")
county_covariate <- subset(county_covariate, county_covariate$state!=2)
county_covariate <- subset(county_covariate, county_covariate$state!=15)

#Merging migration information with covariate data
states1115_migration_covariate <- merge(migration_1115, county_covariate, by="sendfips", all.x=T)

#Ordering data by sending county
migration_1115 <- migration_1115[order(migration_1115$sendfips), ]
```

The structure of the data is as follows:
```{r, echo=FALSE}
head(migration_1115)
```

First, I created a network from the edgelist where each edge is weighted by the number of people who moved from County A (sending county) to County B (receiving county) between 2011 and 2015:

```{r}
edgelist_states1115 <- as.matrix(migration_1115)
graph_states1115 = graph.edgelist(edgelist_states1115[,1:2], directed=T)
E(graph_states1115)$weight = as.numeric(edgelist_states1115[,3])
```

After I construct the data in this manner, I can visualize the data in a number of ways: \\
1. Within state migration (e.g. Texas)
```{r, include=FALSE}
#Subset all migration to and from Texas Counties 
states1115_texas_complete <-subset(states1115_migration_covariate, states1115_migration_covariate$state==48)

#Intra-texas migration
states1115_texas_complete <- states1115_texas_complete[grepl("^48[0-9]", states1115_texas_complete$sendfips), ]
states1115_texas_complete <- states1115_texas_complete[grepl("^48[0-9]", states1115_texas_complete$recfips), ]

#Making weighted edge numeric for the purposes of plotting
states1115_texas_complete$movers <- as.numeric(as.factor(states1115_texas_complete$movers))
```

```{r, echo=F}
# Plot a map of the united states:
map("state", region="texas", col="grey20", fill=TRUE, bg="black", lwd=0.1)

#Generating color gradient for edges in the network 
col.1 <- adjustcolor("orange red", alpha=0.4)
col.2 <- adjustcolor("orange", alpha=0.4)
edge.pal <- colorRampPalette(c(col.1, col.2), alpha = TRUE)
edge.col <- edge.pal(100)

#Generating "arcs" between each pair of coordinates
for(i in 1:nrow(states1115_texas_complete))  {
  node1 <- county_covariate[county_covariate$sendfips == states1115_texas_complete[i,]$sendfips,]
  node2 <- county_covariate[county_covariate$sendfips == states1115_texas_complete[i,]$recfips,]
  
  arc <- gcIntermediate( c(node1[1,]$Longitude, node1[1,]$Latitude), 
                         c(node2[1,]$Longitude, node2[1,]$Latitude), 
                         n=100, addStartEnd=TRUE )
  edge.ind <- round(25*states1115_texas_complete[i,]$movers / max(states1115_texas_complete$movers))
  
  lines(arc, col=edge.col[edge.ind], lwd=edge.ind/30)
}
```

```{r echo=FALSE, out.width='100%'}
knitr::include_graphics('~/Dropbox/github/Migration Data/texas.png')
```

2. Migration to a particular location (i.e. Colorado)
```{r, echo = F, results='hide'}
#Migration to Colorado
states1115_migration_to_colorado <- states1115_migration_covariate[grepl("^8[0-9]", states1115_migration_covariate$recfips), ] 
states1115_migration_to_colorado$movers <- as.numeric(as.factor(states1115_migration_to_colorado$movers ))
  
#Plot map of the United States
map("state", col="grey20", fill=TRUE, bg="black", lwd=0.1)

#Show migration to Colorado from all other counties in the U.S. 
for(i in 1:nrow(states1115_migration_to_colorado))  {
  node1 <- county_covariate[county_covariate$sendfips == states1115_migration_to_colorado[i,]$sendfips,]
  node2 <- county_covariate[county_covariate$sendfips == states1115_migration_to_colorado[i,]$recfips,]
  
  arc <- gcIntermediate( c(node1[1,]$Longitude, node1[1,]$Latitude), 
                         c(node2[1,]$Longitude, node2[1,]$Latitude), 
                         n=100, addStartEnd=TRUE )
  edge.ind <- round(10*states1115_migration_to_colorado[i,]$movers / max(states1115_migration_to_colorado$movers))
  
  lines(arc, col=edge.col[edge.ind], lwd=edge.ind/30)
}
```

```{r echo=FALSE, out.width='100%'}
knitr::include_graphics('~/Dropbox/github/Migration Data/colorado.png')
```

3. Migration from a particular location (i.e. New York City)
```{r, echo = F, results='hide'}
#Migration from counties in NYC (all five boroughs) to other parts of the country
states1115_migration_from_ny <- states1115_migration_covariate[states1115_migration_covariate$sendfips %in% c("36005", "36047", "36061", "36081", "36085"), ] 

states1115_migration_from_ny$movers <- as.numeric(as.factor(states1115_migration_from_ny$movers))

#Show migration from NYC to all other counties in the U.S.
map("state", col="grey20", fill=TRUE, bg="black", lwd=0.1)

#Show migration from NYC to all other counties in the U.S. 
for(i in 1:nrow(states1115_migration_from_ny))  {
  node1 <- states1115_migration_covariate[states1115_migration_covariate$sendfips == states1115_migration_from_ny[i,]$sendfips,]
  node2 <- states1115_migration_covariate[states1115_migration_covariate$sendfips == states1115_migration_from_ny[i,]$recfips,]
  
  arc <- gcIntermediate( c(node1[1,]$Longitude, node1[1,]$Latitude), 
                         c(node2[1,]$Longitude, node2[1,]$Latitude), 
                         n=1000, addStartEnd=TRUE )
  edge.ind <- round(25*states1115_migration_from_ny[i,]$movers / max(states1115_migration_from_ny$movers))
  
  lines(arc, col=edge.col[edge.ind], lwd=edge.ind/30)
}
```

```{r echo=FALSE, out.width='100%'}
knitr::include_graphics('~/Dropbox/github/Migration Data/nyc.png')
```